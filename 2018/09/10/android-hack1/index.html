<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="MicroStudent"><title>一个由SharedPreferences引起的ANR · MicroStudent的博客</title><meta name="description" content="0x01 起因商店每次发布新版本之后，崩溃统计平台排行第一的总是一个奇怪的ANR，他的主线程卡在了这里：1234567891011121314151617181920212223242526272829DALVIK THREADS (108):&amp;quot;main&amp;quot; prio=5 tid="><meta name="keywords" content="Android,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">MicroStudent的博客</a></h3><div class="description"><p>I love learning.</p></div></div></div><ul class="social-links"><li><a href="http://weibo.com/1572542140"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/microstudent"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/assets/images/avatar.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>一个由SharedPreferences引起的ANR</a></h3></div><div class="post-content"><h2 id="0x01-起因"><a href="#0x01-起因" class="headerlink" title="0x01 起因"></a>0x01 起因</h2><p>商店每次发布新版本之后，崩溃统计平台排行第一的总是一个奇怪的ANR，他的主线程卡在了这里：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">DALVIK THREADS (108):</span><br><span class="line">&quot;main&quot; prio=5 tid=1 Waiting</span><br><span class="line">  | group=&quot;main&quot; sCount=1 dsCount=0 obj=0x74b59000 self=0xf4827800</span><br><span class="line">  | sysTid=13783 nice=0 cgrp=default sched=0/0 handle=0xf73c9bec</span><br><span class="line">  | state=S schedstat=( 20710331467 9075524599 28858 ) utm=1820 stm=251 core=5 HZ=100</span><br><span class="line">  | stack=0xff139000-0xff13b000 stackSize=8MB</span><br><span class="line">  | held mutexes=</span><br><span class="line">  at java.lang.Object.wait!(Native method)</span><br><span class="line">  - waiting on &lt;0x031350a8&gt; (a java.lang.Object)</span><br><span class="line">  at java.lang.Thread.parkFor(Thread.java:1220)</span><br><span class="line">  - locked &lt;0x031350a8&gt; (a java.lang.Object)</span><br><span class="line">  at sun.misc.Unsafe.park(Unsafe.java:299)</span><br><span class="line">  at java.util.concurrent.locks.LockSupport.park(LockSupport.java:157)</span><br><span class="line">  at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:813)</span><br><span class="line">  at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:973)</span><br><span class="line">  at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1281)</span><br><span class="line">  at java.util.concurrent.CountDownLatch.await(CountDownLatch.java:202)</span><br><span class="line">  at android.app.SharedPreferencesImpl$EditorImpl$1.run(SharedPreferencesImpl.java:363)</span><br><span class="line">  at android.app.QueuedWork.waitToFinish(QueuedWork.java:88)</span><br><span class="line">  at android.app.ActivityThread.handleStopActivity(ActivityThread.java:3952)</span><br><span class="line">  at android.app.ActivityThread.access$1200(ActivityThread.java:186)</span><br><span class="line">  at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1626)</span><br><span class="line">  at android.os.Handler.dispatchMessage(Handler.java:111)</span><br><span class="line">  at android.os.Looper.loop(Looper.java:194)</span><br><span class="line">  at android.app.ActivityThread.main(ActivityThread.java:5905)</span><br><span class="line">  at java.lang.reflect.Method.invoke!(Native method)</span><br><span class="line">  at java.lang.reflect.Method.invoke(Method.java:372)</span><br><span class="line">  at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:1127)</span><br><span class="line">  at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:893)</span><br></pre></td></tr></table></figure></p>
<p>可以看到，主线程卡在了Activity的handleStopActivity处，正在等待Sharepreference的写入完成。这是什么情况？</p>
<h2 id="0x02-Android源码分析（以android7-1-1源码为准）"><a href="#0x02-Android源码分析（以android7-1-1源码为准）" class="headerlink" title="0x02 Android源码分析（以android7.1.1源码为准）"></a>0x02 Android源码分析（以android7.1.1源码为准）</h2><h3 id="1-这件事情要从SharedPreference的apply方法说起"><a href="#1-这件事情要从SharedPreference的apply方法说起" class="headerlink" title="1. 这件事情要从SharedPreference的apply方法说起"></a>1. 这件事情要从SharedPreference的apply方法说起</h3><p>可以看到SharedPreferences是一个接口，他的实现在SharedPreferencesImpl里面，我们可以看以下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> MemoryCommitResult mcr = commitToMemory();</span><br><span class="line">    <span class="keyword">final</span> Runnable awaitCommit = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mcr.writtenToDiskLatch.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    QueuedWork.add(awaitCommit);<span class="comment">//注意这里！！！</span></span><br><span class="line"></span><br><span class="line">    Runnable postWriteRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                awaitCommit.run();</span><br><span class="line">                QueuedWork.remove(awaitCommit);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    SharedPreferencesImpl.<span class="keyword">this</span>.enqueueDiskWrite(mcr, postWriteRunnable);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Okay to notify the listeners before it's hit disk</span></span><br><span class="line">    <span class="comment">// because the listeners should always get the same</span></span><br><span class="line">    <span class="comment">// SharedPreferences instance back, which has the</span></span><br><span class="line">    <span class="comment">// changes reflected in memory.</span></span><br><span class="line">    notifyListeners(mcr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看到那句QueuedWork.add(awaitCommit)了吗？他把一个Runnable放进了QueuedWork中，而这个Runnable在等待写入的成功返回。</p>
<h3 id="2-QueuedWork是什么鬼？"><a href="#2-QueuedWork是什么鬼？" class="headerlink" title="2. QueuedWork是什么鬼？"></a>2. QueuedWork是什么鬼？</h3><p>还是看代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The set of Runnables that will finish or wait on any async</span></span><br><span class="line"><span class="comment">// activities started by the application.</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentLinkedQueue&lt;Runnable&gt; sPendingWorkFinishers =</span><br><span class="line">         <span class="keyword">new</span> ConcurrentLinkedQueue&lt;Runnable&gt;();</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Add a runnable to finish (or wait for) a deferred operation</span></span><br><span class="line"><span class="comment">  * started in this context earlier.  Typically finished by e.g.</span></span><br><span class="line"><span class="comment">  * an Activity#onPause.  Used by SharedPreferences$Editor#startCommit().</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * Note that this doesn't actually start it running.  This is just</span></span><br><span class="line"><span class="comment">  * a scratch set for callers doing async work to keep updated with</span></span><br><span class="line"><span class="comment">  * what's in-flight.  In the common case, caller code</span></span><br><span class="line"><span class="comment">  * (e.g. SharedPreferences) will pretty quickly call remove()</span></span><br><span class="line"><span class="comment">  * after an add().  The only time these Runnables are run is from</span></span><br><span class="line"><span class="comment">  * waitToFinish(), below.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Runnable finisher)</span> </span>&#123;</span><br><span class="line">     sPendingWorkFinishers.add(finisher);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Finishes or waits for async operations to complete.</span></span><br><span class="line"><span class="comment">  * (e.g. SharedPreferences$Editor#startCommit writes)</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * Is called from the Activity base class's onPause(), after</span></span><br><span class="line"><span class="comment">  * BroadcastReceiver's onReceive, after Service command handling,</span></span><br><span class="line"><span class="comment">  * etc.  (so async work is never lost)</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">waitToFinish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     Runnable toFinish;</span><br><span class="line">     <span class="keyword">while</span> ((toFinish = sPendingWorkFinishers.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">         toFinish.run();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到QueuedWork.add(Runnable)把一个Runnable放进了一个ConcurrentLinkedQueue，一个等待队列。然后还看到了上面trace中看到的熟悉的waitToFinish，是不是一切都一目了然了？<br>android在处理activity、service或广播的时候会执行waitToFinish，以确保之前加入等待队列sPendingWorkFinishers的异步处理能够执行到结束。SharedPreferences就写入了一个等待写入完成的runnable，由于写入性能差、数据量大等原因，可能会导致此处等待时间过长，从而出现ANR的情况。</p>
<h2 id="0x03-如何解决？"><a href="#0x03-如何解决？" class="headerlink" title="0x03 如何解决？"></a>0x03 如何解决？</h2><ol>
<li><p>把apply改为在异步线程执行commit</p>
<p> 可以看源码：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">commit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MemoryCommitResult mcr = commitToMemory();</span><br><span class="line">    SharedPreferencesImpl.<span class="keyword">this</span>.enqueueDiskWrite(</span><br><span class="line">        mcr, <span class="keyword">null</span> <span class="comment">/* sync write on this thread okay */</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mcr.writtenToDiskLatch.await();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    notifyListeners(mcr);</span><br><span class="line">    <span class="keyword">return</span> mcr.writeToDiskResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 好处：没有将等待嫁接到Activity的onStop，很好避免了这个anr。</p>
<p> 缺点：只能修改本地代码，对于第三方SDK使用Apply导致的问题难以解决;需要考虑线程切换问题。</p>
</li>
<li><p>避免同时修改多个值时使用多次提交</p>
<p> 根据《Android移动性能实战》里的说法，commit方法每调用一次就意味着一次文件的打开和关闭，从而造成因commit()方法的随意调用而导致文件的重复打开和关闭。</p>
</li>
<li><p>通过hook的方式，清除sPendingWorkFinishers中的runnable</p>
<p> 目前商店正常尝试使用这个方法进行修复。<br> 实现方式主要是通过修改ActivityThread.mH变量，使用代理模式将其包装起来，拦截其中可能造成ANR的代码，在这些时刻清空QueuedWork的等待队列。<br> 具体代码参考如下：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修复由Sharepreferences导致的ANR</span></span><br><span class="line"><span class="comment"> * hook ActivityThread#mH</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tryHookActityThreadH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> hookSuccess = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class activityThread = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">        Method mH = ReflectionCache.build().getMethod(activityThread, <span class="string">"currentActivityThread"</span>);</span><br><span class="line">        <span class="keyword">if</span> (mH != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Object obj = mH.invoke(activityThread);</span><br><span class="line">            <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Handler handler = (Handler) ReflectHelper.getField(obj, <span class="string">"mH"</span>);</span><br><span class="line">                <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Field mCallbackField = ReflectionCache.build().getDeclaredField(Class.forName(<span class="string">"android.os.Handler"</span>), <span class="string">"mCallback"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (mCallbackField != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mCallbackField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        ActivityThreadHCallbackProxy activityThreadHandler = <span class="keyword">new</span> ActivityThreadHCallbackProxy((Handler.Callback) mCallbackField.get(handler));</span><br><span class="line">                        mCallbackField.set(handler, activityThreadHandler);</span><br><span class="line">                        hookSuccess = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Mlog.tag(TAG).i(<span class="string">"HookActityThreadH:&#123;&#125;"</span>, e.getLocalizedMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    Mlog.tag(TAG).i(<span class="string">"HookActityThreadH:&#123;&#125;"</span>, hookSuccess);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityThreadHCallbackProxy</span> <span class="keyword">implements</span> <span class="title">Handler</span>.<span class="title">Callback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ActivityThreadHCallbackProxy"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> ActivityThread#H&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PAUSE_ACTIVITY          = <span class="number">101</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PAUSE_ACTIVITY_FINISHING= <span class="number">102</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP_ACTIVITY_SHOW      = <span class="number">103</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP_ACTIVITY_HIDE      = <span class="number">104</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SERVICE_ARGS            = <span class="number">115</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOP_SERVICE            = <span class="number">116</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SLEEPING                = <span class="number">137</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Handler.Callback mRawCallback;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActivityThreadHCallbackProxy</span><span class="params">(Handler.Callback callback)</span> </span>&#123;</span><br><span class="line">        mRawCallback = callback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> STOP_ACTIVITY_HIDE:</span><br><span class="line">            <span class="keyword">case</span> STOP_ACTIVITY_SHOW:</span><br><span class="line">                <span class="comment">//stop activity</span></span><br><span class="line">                beforeWaitToFinished();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SERVICE_ARGS:</span><br><span class="line">                <span class="comment">//SERVICE ARGS</span></span><br><span class="line">                beforeWaitToFinished();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STOP_SERVICE:</span><br><span class="line">                <span class="comment">//STOP SERVICE</span></span><br><span class="line">                beforeWaitToFinished();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> SLEEPING:</span><br><span class="line">                <span class="comment">//SLEEPING</span></span><br><span class="line">                beforeWaitToFinished();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PAUSE_ACTIVITY:</span><br><span class="line">            <span class="keyword">case</span> PAUSE_ACTIVITY_FINISHING:</span><br><span class="line">                <span class="comment">//pause activity</span></span><br><span class="line">                beforeWaitToFinished();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mRawCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mRawCallback.handleMessage(message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;<span class="comment">//不能返回true，否则会消耗掉事件</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">beforeWaitToFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QuenedWorkProxy.cleanAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuenedWorkProxy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"QuenedWorkProxy"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CLASS_NAME = <span class="string">"android.app.QueuedWork"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_NAME_PENDDING_WORK_FINISH = <span class="string">"sPendingWorkFinishers"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Collection&lt;Runnable&gt; sPendingWorkFinishers = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> sSupportHook = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 不支持android O</span></span><br><span class="line"><span class="comment">        * android O变量名改为sFinishers</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">cleanAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (sPendingWorkFinishers == <span class="keyword">null</span> &amp;&amp; sSupportHook) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               sPendingWorkFinishers = (ConcurrentLinkedQueue&lt;Runnable&gt;) ReflectHelper.getStaticField(CLASS_NAME, FILE_NAME_PENDDING_WORK_FINISH);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Mlog.tag(TAG).w(<span class="string">"&#123;&#125;"</span>, e.getLocalizedMessage());</span><br><span class="line">                    sSupportHook = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(sPendingWorkFinishers != <span class="keyword">null</span>)&#123;</span><br><span class="line">                Mlog.tag(TAG).d(<span class="string">"clean QuenedWork.sPendingWorkFinishers(&#123;&#125;) size &#123;&#125;"</span> , sPendingWorkFinishers.hashCode() , sPendingWorkFinishers.size());</span><br><span class="line">                sPendingWorkFinishers.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>在Application启动的时候调用tryHookActityThreadH即可实现Hook的效果，需要注意的是sPendingWorkFinishers在android O及以上改为了一个名为sFinishers的LinkedList，但是效果是一样的。这里没有针对android O进行适配。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-09-10</span><i class="fa fa-tag"></i><a class="tag" href="/tags/SharedPreferences/" title="SharedPreferences">SharedPreferences </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://microstudent.github.io/2018/09/10/android-hack1/,MicroStudent的博客,一个由SharedPreferences引起的ANR,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/11/08/kotlin-1/" title="kotlin协程——概念入门">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/08/19/android-performance-optimization-1/" title="Android性能优化之使用AOP结合Systrace查找性能短板">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>